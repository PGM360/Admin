<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans Marketing Group - Saver</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root { --p: #6366f1; --bg: #0b0e14; --c: #161b22; --t: #e6edf3; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; background: var(--c); padding: 30px; border-radius: 15px; position: relative; border: 1px solid #30363d; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .change-pass-link { position: absolute; top: 15px; left: 15px; font-size: 11px; color: #8b949e; cursor: pointer; text-decoration: underline; }
        h1 { text-align: center; color: var(--p); font-size: 24px; margin-top: 10px; margin-bottom: 5px; }
        .tagline { text-align: center; font-size: 10px; color: #8b949e; margin-bottom: 25px; letter-spacing: 1px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #30363d; border-radius: 8px; background: #0d1117; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
        .card { background: #0d1117; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #30363d; }
        .label { font-size: 10px; color: #8b949e; font-weight: bold; }
        .val { font-size: 14px; margin-bottom: 8px; color: #c9d1d9; border-bottom: 1px solid #21262d; }
        footer { text-align: center; margin-top: 30px; font-size: 12px; color: #8b949e; border-top: 1px solid #30363d; padding-top: 15px; }
        .sold-yes { color: #238636; font-weight: bold; }
        .sold-no { color: #da3633; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <span class="change-pass-link" onclick="startOtpProcess()">Change Pass</span>
        <h1>Plans Marketing Group</h1>
        <div class="tagline">PREMIUM DATA SECURITY SYSTEM</div>

        <div id="login-sec">
            <p style="text-align:center">Enter Access Pin</p>
            <input type="password" id="admin-pin" placeholder="Enter Pin">
            <button onclick="checkPin()">Login</button>
            <p id="loading-pin" style="font-size: 10px; text-align: center; color: #8b949e;">Syncing with Cloud...</p>
        </div>

        <div id="otp-sec" class="hidden">
            <p style="text-align:center; color:#eab308">Verify Identity</p>
            <button id="send-btn" onclick="sendOTP()">Send OTP to My Email</button>
            <div id="otp-input-area" class="hidden">
                <input type="text" id="user-otp" placeholder="Enter 6-digit OTP">
                <button onclick="verifyOtpAndChange()">Verify & Change Pin</button>
            </div>
            <button style="background:#30363d" onclick="showSection('login-sec')">Cancel</button>
        </div>

        <div id="menu-sec" class="hidden">
            <button onclick="addNewRecord()">âž• Add New Record</button>
            <button onclick="loadData()">ðŸ“‚ View Database</button>
            <button style="background:#da3633" onclick="location.reload()">Logout</button>
        </div>

        <div id="save-sec" class="hidden">
            <h3 id="ftitle">New Entry</h3>
            <form id="recordForm" onsubmit="saveData(event)">
                <input type="hidden" id="edit-id">
                <label class="label">Record Date</label>
                <input type="date" id="record-date">
                <input type="text" id="channel" placeholder="Channel Name" required>
                <input type="email" id="email" placeholder="Email Address" required>
                <input type="text" id="pass" placeholder="Password" required>
                <textarea id="tfa" placeholder="2FA Recovery Codes"></textarea>
                <label class="label">Sold Status</label>
                <select id="sold-status">
                    <option value="No">No (Available)</option>
                    <option value="Yes">Yes (Sold)</option>
                </select>
                <button type="submit">Save to Cloud</button>
            </form>
            <button style="background:#30363d" onclick="showSection('menu-sec')">Back</button>
        </div>

        <div id="view-sec" class="hidden">
            <h3>Cloud Records</h3>
            <div id="data-list">Loading...</div>
            <button style="background:#30363d" onclick="showSection('menu-sec')">Back</button>
        </div>

        <footer>Developed by: <b>Muhammad Somail</b></footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjsL3MctjTO56QFy5zp2wdRNwdbS-YcE",
            authDomain: "pmgdatabase-d597f.firebaseapp.com",
            projectId: "pmgdatabase-d597f",
            storageBucket: "pmgdatabase-d597f.firebasestorage.app",
            messagingSenderId: "602833717470",
            appId: "1:602833717470:web:48935624f8a99e52d29a4f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        emailjs.init("d5Oj6jVHMPg85UjuF");

        let currentPin = "1234"; // Default
        let generatedOtp = "";

        // Cloud se Pin fetch karna
        function syncPin() {
            db.collection("settings").doc("admin_config").onSnapshot((doc) => {
                if (doc.exists) {
                    currentPin = doc.data().pin;
                    document.getElementById('loading-pin').innerText = "Cloud Synced âœ…";
                } else {
                    // Agar database mein settings nahi hain toh default 1234 set kar do
                    db.collection("settings").doc("admin_config").set({ pin: "1234" });
                }
            });
        }
        syncPin();

        function showSection(id) {
            ['login-sec','otp-sec','menu-sec','save-sec','view-sec'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function checkPin() {
            if(document.getElementById('admin-pin').value === currentPin) {
                showSection('menu-sec');
            } else {
                alert("Wrong Pin!");
            }
        }

        function startOtpProcess() { showSection('otp-sec'); }

        function sendOTP() {
            generatedOtp = Math.floor(100000 + Math.random() * 900000);
            document.getElementById('send-btn').innerText = "Sending...";
            emailjs.send("service_cc4i41o", "template_89y4rrd", {
                to_email: "msomailx720@gmail.com",
                otp_code: generatedOtp,
                from_name: "Plans Marketing Group"
            }).then(() => {
                alert("OTP Sent!");
                document.getElementById('otp-input-area').classList.remove('hidden');
            });
        }

        function verifyOtpAndChange() {
            if(document.getElementById('user-otp').value == generatedOtp) {
                let newPin = prompt("Enter New Pin for ALL devices:");
                if(newPin) {
                    // Database mein update karein taaki har jagah change ho jaye
                    db.collection("settings").doc("admin_config").update({ pin: newPin })
                    .then(() => {
                        alert("Pin Updated on Cloud! All devices synced.");
                        showSection('login-sec');
                    });
                }
            } else { alert("Invalid OTP!"); }
        }

        function addNewRecord() {
            document.getElementById('recordForm').reset();
            document.getElementById('edit-id').value = "";
            showSection('save-sec');
        }

        function saveData(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                date: document.getElementById('record-date').value,
                channel: document.getElementById('channel').value,
                email: document.getElementById('email').value,
                pass: document.getElementById('pass').value,
                tfa: document.getElementById('tfa').value,
                sold: document.getElementById('sold-status').value,
                updated: new Date().toLocaleString()
            };
            const ref = db.collection("accounts");
            const action = id ? ref.doc(id).update(data) : ref.add(data);
            action.then(() => {
                alert("Saved!");
                showSection('menu-sec');
            });
        }

        function loadData() {
            showSection('view-sec');
            db.collection("accounts").onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const sClass = d.sold === 'Yes' ? 'sold-yes' : 'sold-no';
                    h += `<div class="card">
                        <div class="label">Date: ${d.date} | Status: <span class="${sClass}">${d.sold}</span></div>
                        <div class="val"><b>${d.channel}</b></div>
                        <div class="val">${d.email}</div>
                        <button onclick="edit('${doc.id}','${d.date}','${d.channel}','${d.email}','${d.pass}','${d.tfa}','${d.sold}')">Edit</button>
                        <button style="background:#da3633" onclick="del('${doc.id}')">Delete</button>
                    </div>`;
                });
                document.getElementById('data-list').innerHTML = h || "No records.";
            });
        }

        function del(id) { if(confirm("Delete?")) db.collection("accounts").doc(id).delete(); }

        function edit(id, date, c, e, p, t, sold) {
            document.getElementById('edit-id').value = id;
            document.getElementById('record-date').value = date;
            document.getElementById('channel').value = c;
            document.getElementById('email').value = e;
            document.getElementById('pass').value = p;
            document.getElementById('tfa').value = t;
            document.getElementById('sold-status').value = sold;
            showSection('save-sec');
        }
    </script>
</body>
</html>
