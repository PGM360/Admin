<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans Marketing Group - Saver</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root { --p: #6366f1; --bg: #0b0e14; --c: #161b22; --t: #e6edf3; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; background: var(--c); padding: 30px; border-radius: 15px; position: relative; border: 1px solid #30363d; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .change-pass-link { position: absolute; top: 15px; left: 15px; font-size: 11px; color: #8b949e; cursor: pointer; text-decoration: underline; }
        h1 { text-align: center; color: var(--p); font-size: 24px; margin-top: 10px; margin-bottom: 5px; }
        .tagline { text-align: center; font-size: 10px; color: #8b949e; margin-bottom: 25px; letter-spacing: 1px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #30363d; border-radius: 8px; background: #0d1117; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--p); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
        .card { background: #0d1117; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #30363d; }
        .label { font-size: 10px; color: #8b949e; font-weight: bold; }
        .val { font-size: 14px; margin-bottom: 8px; color: #c9d1d9; border-bottom: 1px solid #21262d; }
        footer { text-align: center; margin-top: 30px; font-size: 12px; color: #8b949e; border-top: 1px solid #30363d; padding-top: 15px; }
        .sold-yes { color: #238636; font-weight: bold; }
        .sold-no { color: #da3633; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <span class="change-pass-link" onclick="startOtpProcess()">Change Pass</span>
        <h1>Plans Marketing Group</h1>
        <div class="tagline">PREMIUM DATA SECURITY SYSTEM</div>

        <div id="login-sec">
            <p style="text-align:center">Enter Access Pin</p>
            <input type="password" id="admin-pin" placeholder="Enter Pin">
            <button onclick="checkPin()">Login</button>
        </div>

        <div id="otp-sec" class="hidden">
            <p style="text-align:center; color:#eab308">Verify Identity</p>
            <button id="send-btn" onclick="sendOTP()">Send OTP to My Email</button>
            <div id="otp-input-area" class="hidden">
                <input type="text" id="user-otp" placeholder="Enter 6-digit OTP">
                <button onclick="verifyOtpAndChange()">Verify & Change Pin</button>
            </div>
            <button style="background:#30363d" onclick="showSection('login-sec')">Cancel</button>
        </div>

        <div id="menu-sec" class="hidden">
            <button onclick="addNewRecord()">âž• Add New Record</button>
            <button onclick="loadData()">ðŸ“‚ View Database</button>
            <button style="background:#da3633" onclick="location.reload()">Logout (Refresh)</button>
        </div>

        <div id="save-sec" class="hidden">
            <h3 id="ftitle">New Entry</h3>
            <input type="hidden" id="edit-id">
            
            <label class="label">Record Date</label>
            <input type="date" id="record-date">
            
            <input type="text" id="channel" placeholder="Channel Name">
            <input type="email" id="email" placeholder="Email Address">
            <input type="text" id="pass" placeholder="Password">
            <textarea id="tfa" placeholder="2FA Recovery Codes"></textarea>
            
            <label class="label">Sold Status</label>
            <select id="sold-status">
                <option value="No">No (Available)</option>
                <option value="Yes">Yes (Sold)</option>
            </select>

            <button onclick="saveData()">Save to Cloud</button>
            <button style="background:#30363d" onclick="showSection('menu-sec')">Back to Menu</button>
        </div>

        <div id="view-sec" class="hidden">
            <h3>Cloud Records</h3>
            <div id="data-list">Loading...</div>
            <button style="background:#30363d" onclick="showSection('menu-sec')">Back to Menu</button>
        </div>

        <footer>Developed by: <b>Muhammad Somail</b></footer>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsL3MctjTO56QFy5zp2wdRNwdbS-YcE",
            authDomain: "pmgdatabase-d597f.firebaseapp.com",
            projectId: "pmgdatabase-d597f",
            storageBucket: "pmgdatabase-d597f.firebasestorage.app",
            messagingSenderId: "602833717470",
            appId: "1:602833717470:web:48935624f8a99e52d29a4f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // EmailJS Configuration
        const PUBLIC_KEY = "d5Oj6jVHMPg85UjuF";
        const SERVICE_ID = "service_cc4i41o";
        const TEMPLATE_ID = "template_89y4rrd";
        emailjs.init(PUBLIC_KEY);

        // Fix: Persistent Pin Management
        let currentPin = localStorage.getItem('adminPin') || "1234";
        let generatedOtp = "";

        function showSection(id) {
            ['login-sec','otp-sec','menu-sec','save-sec','view-sec'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function checkPin() {
            const inputPin = document.getElementById('admin-pin').value;
            if(inputPin === currentPin) {
                showSection('menu-sec');
                document.getElementById('admin-pin').value = ""; // Clear for security
            } else {
                alert("Wrong Pin!");
            }
        }

        function startOtpProcess() { showSection('otp-sec'); }

        function sendOTP() {
            generatedOtp = Math.floor(100000 + Math.random() * 900000);
            const btn = document.getElementById('send-btn');
            btn.innerText = "Sending...";
            const params = { to_email: "msomailx720@gmail.com", otp_code: generatedOtp, from_name: "Plans Marketing Group" };
            emailjs.send(SERVICE_ID, TEMPLATE_ID, params).then(() => {
                alert("OTP sent to msomailx720@gmail.com");
                document.getElementById('otp-input-area').classList.remove('hidden');
                btn.innerText = "Resend OTP";
            });
        }

        function verifyOtpAndChange() {
            if(document.getElementById('user-otp').value == generatedOtp) {
                let newPin = prompt("OTP Verified! Enter New Pin:");
                if(newPin && newPin.trim() !== "") { 
                    currentPin = newPin; 
                    localStorage.setItem('adminPin', newPin); // Fix: Permanent save
                    alert("Pin Updated! Use your new pin to login."); 
                    showSection('login-sec'); 
                }
            } else { alert("Invalid OTP!"); }
        }

        function addNewRecord() {
            document.getElementById('edit-id').value = "";
            document.getElementById('record-date').value = "";
            document.getElementById('channel').value = "";
            document.getElementById('email').value = "";
            document.getElementById('pass').value = "";
            document.getElementById('tfa').value = "";
            document.getElementById('sold-status').value = "No";
            document.getElementById('ftitle').innerText = "New Entry";
            showSection('save-sec');
        }

        function saveData() {
            const id = document.getElementById('edit-id').value;
            const data = {
                date: document.getElementById('record-date').value,
                channel: document.getElementById('channel').value,
                email: document.getElementById('email').value,
                pass: document.getElementById('pass').value,
                tfa: document.getElementById('tfa').value,
                sold: document.getElementById('sold-status').value,
                updated: new Date().toLocaleString()
            };
            
            const ref = db.collection("accounts"); // Collection: accounts
            
            const action = id ? ref.doc(id).update(data) : ref.add(data);
            
            action.then(() => {
                alert("Data Saved Successfully!");
                // Fix: No auto-logout, go back to menu
                showSection('menu-sec');
            }).catch(e => alert("Error: " + e.message));
        }

        function loadData() {
            showSection('view-sec');
            // Using Snapshot for real-time updates
            db.collection("accounts").onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const soldClass = d.sold === 'Yes' ? 'sold-yes' : 'sold-no';
                    h += `<div class="card">
                        <div class="label">Date</div><div class="val">${d.date || 'N/A'}</div>
                        <div class="label">Sold Status</div><div class="val ${soldClass}">${d.sold || 'No'}</div>
                        <div class="label">Channel</div><div class="val">${d.channel || 'N/A'}</div>
                        <div class="label">Email</div><div class="val">${d.email || 'N/A'}</div>
                        <div class="label">Password</div><div class="val">${d.pass || 'N/A'}</div>
                        <button style="background:#eab308; padding:5px; margin-top:5px;" onclick="edit('${doc.id}','${d.date}','${d.channel}','${d.email}','${d.pass}','${d.tfa}','${d.sold}')">Edit</button>
                        <button style="background:#da3633; padding:5px;" onclick="del('${doc.id}')">Delete</button>
                    </div>`;
                });
                document.getElementById('data-list').innerHTML = h || "No records found.";
            });
        }

        function del(id) { if(confirm("Are you sure you want to delete?")) db.collection("accounts").doc(id).delete(); }
        
        function edit(id, date, c, e, p, t, sold) {
            document.getElementById('edit-id').value = id;
            document.getElementById('record-date').value = date || "";
            document.getElementById('channel').value = c;
            document.getElementById('email').value = e;
            document.getElementById('pass').value = p;
            document.getElementById('tfa').value = t;
            document.getElementById('sold-status').value = sold || "No";
            document.getElementById('ftitle').innerText = "Update Record";
            showSection('save-sec');
        }
    </script>
</body>
</html>
